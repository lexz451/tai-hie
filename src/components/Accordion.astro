---
const { class: classes, defaultItem, id } = Astro.props;
---

<ul
    id={id}
    class:list={["accordion-wrapper", classes]}
    data-default={defaultItem}
>
    <slot />
</ul>
<style>
    ul.accordion-wrapper {
        list-style: none;
        padding: 0;
        margin: 0;
    }
</style>
<script>
    import { activeItem, toggleItem } from "../store/accordion";

    const accordion = document.querySelector(".accordion-wrapper");
    const defaultItem = accordion.getAttribute("data-default");
    const event = accordion.getAttribute("data-event");

    activeItem.set(defaultItem || null);

    const accordionItems = document.querySelectorAll(".accordion-item");

    for (const accordionItem of accordionItems) {
        const accordionItemKey = accordionItem.getAttribute("data-key");

        const accordionItemHeader = accordionItem.querySelector(
            ".accordion-item--header",
        );
        const accordionItemBody = accordionItem.querySelector(
            ".accordion-item--body",
        );

        activeItem.subscribe((key) => {
            if (key === accordionItemKey) {
                accordionItem.classList.add("accordion-item--active");
                accordionItem.setAttribute("aria-expanded", "true");
                (accordionItemBody as HTMLElement).style.maxHeight = `${
                    (accordionItemBody as HTMLElement).scrollHeight
                }px`;
            } else {
                accordionItem.classList.remove("accordion-item--active");
                accordionItem.setAttribute("aria-expanded", "false");
                (accordionItemBody as HTMLElement).style.maxHeight = null;
            }
        });

        accordionItemHeader.addEventListener("click", () => {
            toggleItem(accordionItemKey);
        });
    }
</script>
